# Voice2Text Bot

Телеграм-бот, который **превращает голосовые и видео в текст**.

* **Голосовые (`voice`)** — работают **в личке и в группах**.
* **Видео (`video` / документ с `video/*`)** — **только в личке**.
* Для видео: **автоопределение языка** и, если это не русский, — **офлайн-перевод в русский** (Argos Translate).
* Длинные расшифровки отправляются **чанками** (без ошибок “message is too long”).
* Все временные файлы сохраняются **во временный каталог** и **удаляются сразу** после обработки.
* Кэш моделей хранится в volume, чтобы **не качать** 700 МБ–1.4 ГБ при каждом рестарте.

---

## Стек (и почему)

* **Python 3.11** — стабильные колёса для ML/перевода, меньше проблем со сборкой.
* **aiogram 3.x** — современный асинхронный Telegram-фреймворк.
* **OpenAI Whisper (medium)** — отличная точность для RU; офлайн.
* **ffmpeg** — извлечение аудиодорожки и конвертация.
* **Argos Translate** — офлайн-перевод для нерусских видео → RU.
* **Docker / Compose** — воспроизводимый запуск одной командой.

---

## Быстрый старт (Docker)

1. Склонировать и подготовить `.env`:

```bash
git clone https://github.com/<your>/voice2text-bot.git
cd voice2text-bot
cp .env.example .env  # впиши свой BOT_TOKEN
```

2. Запустить:

```bash
docker compose build
docker compose up -d
docker compose logs -f
```

Ожидаешь в логах: `✅ Бот запущен`.

> Мы монтируем кэш в volume, чтобы модели Whisper/Argos сохранялись между рестартами.

---

## Локальный запуск (без Docker)

```bash
python3.11 -m venv venv311
source venv311/bin/activate
pip install -r requirements.txt
cp .env.example .env  # впиши BOT_TOKEN
python main.py
```

---

## Как пользоваться

* **Личка**: отправь голосовое или видео → получишь текст.
* **Группа**: отправь голосовое → получишь текст. Видео в группах игнорируются.
* Английское видео → бот автоопределит язык и **переведёт на русский** (офлайн).

---

## Конфигурация

* `BOT_TOKEN` — токен бота (в `.env`).
* Кэш моделей внутри контейнера: `/home/botuser/.cache` (volume `bot-cache`).
* Временные файлы: системный tmp + удаление сразу после распознавания.

---

## Ограничения

* Максимальный размер скачиваемого файла: \~**19 MB** (порог для бота в Telegram).
* В каналах бот не обрабатывает сообщения (ограничение Telegram).
* На CPU Whisper работает медленнее, чем на GPU (нормально для мини-сервера).
* Первое скачивание модели может занять время (кэш сохраняется).

---

## Частые вопросы / проблемы

**Сообщение слишком длинное** — бот режет ответ на части автоматически.
**“Bad Request: file is too big”** — отправь файл до \~19 MB.
**Каждый раз скачивается модель** — проверь, что в `docker-compose.yml` включён volume:

```yaml
volumes:
  - bot-cache:/home/botuser/.cache
```

и **права** внутри контейнера:

```bash
docker compose exec voice2text-bot bash -lc 'ls -ld ~/.cache && id -u'
```

должно принадлежать `botuser`.

**FP16 is not supported on CPU** — инфо-предупреждение, можно игнорировать.

---

## Структура проекта

```
voice2text-bot/
├── bot/
│   ├── handlers.py       # обработчики: voice, video (video — только в личке), чанкинг ответов
│   └── transcriber.py    # ffmpeg → wav → whisper; перевод видео в RU (Argos)
├── config/
│   └── config.py         # BOT_TOKEN из .env
├── main.py               # запуск aiogram, роутеры
├── requirements.txt
├── Dockerfile
├── docker-compose.yml
├── .env.example          # пример .env
├── .dockerignore         # облегчает сборку
└── .gitignore
```

---

## Лицензия

MIT
